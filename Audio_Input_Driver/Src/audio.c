/****************************************************************************/
/*  Source    : audio.c														*/
/****************************************************************************/
/*                                                                          */
/*  @file     : audio.c														*/
/*                                                                          */
/*  @brief	  : File to handle audio input									*/
/*                                                                          */
/*  @author   : Francis Liechti (FL)                                        */
/*                                                                          */
/*  @date	  : 11.03.2025  				                        		*/
/*                                                                          */
/****************************************************************************/

/*----- Header-Files -----------------------------------------------------*/
#include "audio.h"

/*----- Defines  ---------------------------------------------------------*/
#define TIMEOUT HAL_MAX_DELAY


// Filtering
#define FILTER_ORDER_NUM 256
#define FILTER_ORDER_DEN 1

#define FFT_SIZE 512


/*----- Data ---------------------------------------------------------*/

/*----- Private variables ---------------------------------------------------------*/
float filter_numerator[FILTER_ORDER_NUM+1] = { -0.0003756224994776, -0.0003369431019081, -0.0002781565043601, -0.0002069986124761, -0.0001330074584534, -0.0000664636475573, -0.0000171831495490, 0.0000067244917099, -0.0000000000000000, -0.0000388621982490, -0.0001070886234117, -0.0001975933877667, -0.0002995060265350, -0.0003992655566701, -0.0004822078943135, -0.0005344917562235, -0.0005451347237297, -0.0005078800719575, -0.0004225988408490, -0.0002959592279965, -0.0001411694353808, 0.0000232842230494, 0.0001758375367713, 0.0002947664659742, 0.0003614629528811, 0.0003636078681905, 0.0002977405693058, 0.0001707593411394, -0.0000000000000000, -0.0001882777937703, -0.0003619368196258, -0.0004872350752231, -0.0005337940542852, -0.0004795665031985, -0.0003150351838515, -0.0000459154320436, 0.0003062057462724, 0.0007055962285288, 0.0011064346920643, 0.0014587941816171, 0.0017158143401893, 0.0018410699047752, 0.0018150210158573, 0.0016394711862794, 0.0013391695606612, 0.0009600574185424, 0.0005641313246168, 0.0002214127628409, -0.0000000000000000, -0.0000444455775228, 0.0001217734746604, 0.0005033803987742, 0.0010729027823907, 0.0017720383695296, 0.0025177734070881, 0.0032127105309104, 0.0037583823356291, 0.0040697793049065, 0.0040890001679528, 0.0037959047129929, 0.0032139395690167, 0.0024098958481129, 0.0014871765201916, 0.0005730939607604, -0.0001983489554858, -0.0007059586172032, -0.0008603923132904, -0.0006198732307493, 0.0000000000000000, 0.0009242334469625, 0.0020250683394477, 0.0031368998882330, 0.0040778691917045, 0.0046754128729431, 0.0047922814611070, 0.0043492264884115, 0.0033407843715587, 0.0018413543062449, -0.0000000000000000, -0.0019760495583341, -0.0038475729958873, -0.0053760516257169, -0.0063585695275793, -0.0066599870887034, -0.0062375178948890, -0.0051536103479692, -0.0035744504989886, -0.0017532979636596, 0.0000000000000000, 0.0013598913574357, 0.0020312489083968, 0.0017944941693991, 0.0005431796174209, -0.0016918800287059, -0.0047363323986334, -0.0082860484623378, -0.0119404243079352, -0.0152519470856774, -0.0177862439805931, -0.0191849695356388, -0.0192229602446042, -0.0178512794103444, -0.0152191293302459, -0.0116700049676933, -0.0077106382340465, -0.0039548504010277, -0.0010479347403371, 0.0004198394429037, 0.0000000000000000, -0.0025384142281879, -0.0071548334887568, -0.0135133461415682, -0.0209942810759814, -0.0287421995001722, -0.0357468030528946, -0.0409489765049989, -0.0433606687138041, -0.0421850494993415, -0.0369226943079495, -0.0274505846605026, -0.0140633989097714, 0.0025293764801051, 0.0212520202629736, 0.0407530506016512, 0.0595288411351802, 0.0760675698393131, 0.0889980744268326, 0.0972273426589254, 0.1000514177977891, 0.0972273426589254, 0.0889980744268326, 0.0760675698393131, 0.0595288411351802, 0.0407530506016512, 0.0212520202629736, 0.0025293764801051, -0.0140633989097714, -0.0274505846605026, -0.0369226943079495, -0.0421850494993415, -0.0433606687138041, -0.0409489765049989, -0.0357468030528946, -0.0287421995001722, -0.0209942810759814, -0.0135133461415682, -0.0071548334887568, -0.0025384142281879, 0.0000000000000000, 0.0004198394429037, -0.0010479347403371, -0.0039548504010277, -0.0077106382340465, -0.0116700049676933, -0.0152191293302459, -0.0178512794103444, -0.0192229602446042, -0.0191849695356388, -0.0177862439805931, -0.0152519470856774, -0.0119404243079352, -0.0082860484623378, -0.0047363323986334, -0.0016918800287059, 0.0005431796174209, 0.0017944941693991, 0.0020312489083968, 0.0013598913574357, 0.0000000000000000, -0.0017532979636596, -0.0035744504989886, -0.0051536103479692, -0.0062375178948890, -0.0066599870887034, -0.0063585695275793, -0.0053760516257169, -0.0038475729958873, -0.0019760495583341, -0.0000000000000000, 0.0018413543062449, 0.0033407843715587, 0.0043492264884115, 0.0047922814611070, 0.0046754128729431, 0.0040778691917045, 0.0031368998882330, 0.0020250683394477, 0.0009242334469625, 0.0000000000000000, -0.0006198732307493, -0.0008603923132904, -0.0007059586172032, -0.0001983489554858, 0.0005730939607604, 0.0014871765201916, 0.0024098958481129, 0.0032139395690167, 0.0037959047129929, 0.0040890001679528, 0.0040697793049065, 0.0037583823356291, 0.0032127105309104, 0.0025177734070881, 0.0017720383695296, 0.0010729027823907, 0.0005033803987742, 0.0001217734746604, -0.0000444455775228, -0.0000000000000000, 0.0002214127628409, 0.0005641313246168, 0.0009600574185424, 0.0013391695606612, 0.0016394711862794, 0.0018150210158573, 0.0018410699047752, 0.0017158143401893, 0.0014587941816171, 0.0011064346920643, 0.0007055962285288, 0.0003062057462724, -0.0000459154320436, -0.0003150351838515, -0.0004795665031985, -0.0005337940542852, -0.0004872350752231, -0.0003619368196258, -0.0001882777937703, -0.0000000000000000, 0.0001707593411394, 0.0002977405693058, 0.0003636078681905, 0.0003614629528811, 0.0002947664659742, 0.0001758375367713, 0.0000232842230494, -0.0001411694353808, -0.0002959592279965, -0.0004225988408490, -0.0005078800719575, -0.0005451347237297, -0.0005344917562235, -0.0004822078943135, -0.0003992655566701, -0.0002995060265350, -0.0001975933877667, -0.0001070886234117, -0.0000388621982490, -0.0000000000000000, 0.0000067244917099, -0.0000171831495490, -0.0000664636475573, -0.0001330074584534, -0.0002069986124761, -0.0002781565043601, -0.0003369431019081, -0.0003756224994776 };
float filter_denuminator[FILTER_ORDER_DEN] = {1};

float32_t input[2 * FFT_SIZE];      // Interleaved real/imag for FFT
arm_cfft_instance_f32 fft_inst;


/**
 * @brief		filterData
 *
 * @param       uint16t* Rawvalues
 *
 * @param		uint16_t* FilteredValues
 *
 * @param       int samplenumber
 *
 * @param		int MAX_entry
 *
 * @return		void
 *
 * @details		Function that adapts a digital filter (FIR or IIR), which values are defined in private variables
 * 				Directly calculates the filtered value for a sample and gives it back into structure.
 * 				To make a FIR, set the order Denuminator to 1
 * 				Filter was designed using MATLAB (FIR, bandpass between 0.5Hz and 3Hz)
 *
 * @author		Francis Liechti (FL)
 * @date		16.12.2024	FL	Created
 * 				11.03.2025	FL	Adapted
 ****************************************************************************/
void filterData(uint16_t *RawValues, int16_t *FilteredValues, uint16_t samplenumber, uint16_t Max_entry){
	float numerator = 0;
	float denominator = 0;

	for(int i=0; i<FILTER_ORDER_NUM+1; i++){
		if((samplenumber - i) < 0){
			numerator += RawValues[Max_entry + samplenumber - i] * filter_numerator[i];
		} else {
			numerator += RawValues[samplenumber - i] * filter_numerator[i];

		}
	}
	if(FILTER_ORDER_DEN > 1){
		for(int i=0; i<FILTER_ORDER_DEN; i++){
			if((samplenumber - i -1) < 0){
				denominator += RawValues[Max_entry + samplenumber - i - 1] * filter_denuminator[i];
			} else {
				denominator += RawValues[samplenumber - i - 1] * filter_numerator[i];
			}
		}
	} else{
		denominator = 1;
	}
	// calculate filtered values
	FilteredValues[samplenumber] = numerator / denominator;
}


/**
 * @brief		FFT
 *
 * @param      	float32_t* Result
 *
 * @param		int32_t* input
 *
 * @return		void
 *
 * @details		Function that adapts a digital filter (FIR or IIR), which values are defined in private variables
 * 				Directly calculates the filtered value for a sample and gives it back into structure.
 * 				To make a FIR, set the order Denuminator to 1
 * 				Filter was designed using MATLAB (FIR, bandpass between 0.5Hz and 3Hz)
 *
 * @author		Francis Liechti (FL)
 * @date		16.12.2024	FL	Created
 * 				11.03.2025	FL	Adapted
 ****************************************************************************/
void performFFT(float *Result, int32_t *audiodata){
	// 1. Fill input
	for (int i = 0; i < FFT_SIZE; i++) {
		// Normalize if desired: value âˆˆ [-131072, +131071]
		float normalized = ((float) audiodata[i]) / 131072.0f;

		input[2*i] = normalized;      // Real part
		input[2*i + 1] = 0.0f;        // Imaginary part (0 for real signals)
	}

	 // 2. Initialize the FFT structure
	arm_cfft_init_f32(&fft_inst, FFT_SIZE);

	// 3. Perform the complex FFT in-place
	arm_cfft_f32(&fft_inst, input, 0, 1);  // Forward FFT, with bit reversal

	// 4. Compute magnitude from real and imaginary parts
	for (int i = 0; i < FFT_SIZE; i++) {
		float real = input[2 * i];
		float imag = input[2 * i + 1];
		Result[i] = sqrtf(real * real + imag * imag);
	}
}
